<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回收站 - 云盘存储</title>
    <link rel="stylesheet" href="style_2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="api.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#4080FF',
                        neutral: '#F5F7FA',
                        dark: '#1D2129',
                        'gray-light': '#C9CDD4'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 2px 10px rgba(0, 0, 0, 0.05)',
                        'hover': '0 5px 15px rgba(22, 93, 255, 0.08)'
                    }
                }
            }
        }
    </script>
</head>
<body class="font-inter bg-neutral min-h-screen flex flex-col text-dark overflow-hidden">
    <div id="app">
        <router-view></router-view>
    </div>

    <script>
        // 路由守卫 - 验证登录状态
        const authGuard = (to, from, next) => {
            const token = localStorage.getItem('cloudDiskToken');
            if (!token && to.name !== 'login') {
                window.location.href = 'login.html';
                return;
            } else {
                next();
            }
        };

        // 布局组件 - 头部
        const Header = {
            template: `
                <header class="header">
                    <div class="header-left">
                        <button @click="toggleSidebar" class="sidebar-toggle md:hidden">
                            <i class="fa fa-bars"></i>
                        </button>
                        <div class="logo-container">
                            <i class="logo-icon fa fa-cloud"></i>
                            <span class="logo-text">云盘存储</span>
                        </div>
                    </div>
                    
                    <div class="header-right">
                        <div class="search-container">
                            <input 
                                type="text" 
                                placeholder="搜索文件和文件夹..." 
                                class="search-input"
                            >
                            <i class="search-icon fa fa-search"></i>
                        </div>
                        
                        <div class="user-menu-container" @click="showUserMenu = !showUserMenu">
                            <button class="user-menu-button">
                                <span class="user-name">{{ userName }}</span>
                                <i class="dropdown-icon fa fa-chevron-down"></i>
                            </button>
                            
                            <div v-if="showUserMenu" class="user-menu">
                                <a href="profile.html" class="user-menu-item">
                                    <i class="fa fa-user"></i> 个人中心
                                </a>
                                <a href="storage.html" class="user-menu-item">
                                    <i class="fa fa-chart-pie"></i> 存储分析
                                </a>
                                <div class="divider"></div>
                                <button class="user-menu-item logout-button" @click="logout">
                                    <i class="fa fa-sign-out"></i> 退出登录
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
            `,
            data() {
                return {
                    showUserMenu: false,
                    userName: this.getCurrentUserName()
                }
            },
            methods: {
                toggleSidebar() {
                    this.$emit('toggle-sidebar');
                },
                logout() {
                    localStorage.removeItem('cloudDiskToken');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                },
                getCurrentUserName() {
                    const user = localStorage.getItem('currentUser');
                    return user ? JSON.parse(user).username : '用户';
                }
            }
        };

        // 布局组件 - 侧边栏
        const Sidebar = {
            template: `
                <aside :class="['sidebar', isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0']">
                    <div class="sidebar-content">
                        <div class="sidebar-section">
                            <div class="sidebar-item" @click="navigateTo('file-manager.html')">
                                <i class="sidebar-icon fa fa-folder"></i>
                                <span class="sidebar-text">文件库</span>
                            </div>
                            <div class="sidebar-item active" @click="navigateTo('recycle-bin.html')">
                                <i class="sidebar-icon fa fa-trash"></i>
                                <span class="sidebar-text">回收站</span>
                            </div>
                            <div class="sidebar-item" @click="navigateTo('my-shares.html')">
                                <i class="sidebar-icon fa fa-share-alt"></i>
                                <span class="sidebar-text">我的分享</span>
                            </div>
                            <div class="sidebar-item" @click="navigateTo('sync-folder.html')">
                                <i class="sidebar-icon fa fa-book"></i>
                                <span class="sidebar-text">同步文件夹</span>
                            </div>
                        </div>
                        
                        <div class="sidebar-section">
                            <div class="sidebar-title">文件分类</div>
                            <div class="sidebar-item" @click="navigateTo('file-manager.html?type=image')">
                                <i class="sidebar-icon fa fa-image"></i>
                                <span class="sidebar-text">图片</span>
                            </div>
                            <div class="sidebar-item" @click="navigateTo('file-manager.html?type=document')">
                                <i class="sidebar-icon fa fa-file-text"></i>
                                <span class="sidebar-text">文档</span>
                            </div>
                            <div class="sidebar-item" @click="navigateTo('file-manager.html?type=video')">
                                <i class="sidebar-icon fa fa-video-camera"></i>
                                <span class="sidebar-text">视频</span>
                            </div>
                            <div class="sidebar-item" @click="navigateTo('file-manager.html?type=audio')">
                                <i class="sidebar-icon fa fa-music"></i>
                                <span class="sidebar-text">音频</span>
                            </div>
                        </div>
                        
                        <!-- 存储使用情况 -->
                        <div class="storage-info">
                            <div class="storage-title">存储空间</div>
                            <div class="storage-stats">
                                <span>{{ usedStorage }} GB</span>
                                <span>{{ usedPercent }}% 已使用</span>
                            </div>
                            <div class="storage-bar">
                                <div 
                                    class="storage-progress"
                                    :style="{ width: usedPercent + '%' }"
                                ></div>
                            </div>
                            <div class="storage-total">总计 {{ totalStorage }} GB</div>
                            <button class="upgrade-button">升级存储空间</button>
                        </div>
                    </div>
                </aside>
            `,
            props: ['isOpen'],
            data() {
                return {
                    usedStorage: '2.5',
                    totalStorage: '10',
                    usedPercent: 25
                }
            },
            methods: {
                navigateTo(page) {
                    window.location.href = page;
                }
            }
        };

        // 布局组件 - 底部状态栏
        const Footer = {
            template: `
                <footer class="bg-white border-t px-4 py-2 text-sm text-gray-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <span v-if="selectedCount > 0">{{ selectedCount }} 个文件被选中</span>
                            <span v-else>共 {{ totalFiles }} 个文件</span>
                        </div>
                        <div>已删除 {{ deletedStorage }} GB</div>
                    </div>
                </footer>
            `,
            props: ['selectedCount', 'totalFiles', 'deletedStorage']
        };

        // 回收站主组件
        const RecycleBin = {
            template: `
                <div class="flex flex-col h-screen">
                    <!-- 头部 -->
                    <Header @toggle-sidebar="toggleSidebar"></Header>
                    
                    <!-- 主内容区 -->
                    <div class="flex flex-1 overflow-hidden">
                        <!-- 侧边栏 -->
                        <Sidebar :is-open="sidebarOpen"></Sidebar>
                        
                        <!-- 遮罩层 - 移动端侧边栏打开时显示 -->
                        <div 
                            v-if="sidebarOpen && isMobile" 
                            class="overlay md:hidden"
                            @click="toggleSidebar"
                        ></div>
                        
                        <!-- 主工作区 -->
                        <main class="flex-1 overflow-auto p-4 md:p-6">
                            <!-- 页面标题和操作区 -->
                            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                                <div>
                                    <h2 class="text-2xl font-bold">回收站</h2>
                                    <p class="text-gray-500 mt-1">已删除的文件将在此保留30天，之后会永久删除</p>
                                </div>
                                <div class="flex gap-2">
                                    <button 
                                        class="toolbar-btn flex items-center gap-1" 
                                        :disabled="selectedFiles.length === 0" 
                                        @click="restoreSelected"
                                    >
                                        <i class="fa fa-undo"></i>
                                        <span>还原所选</span>
                                    </button>
                                    <button 
                                        class="toolbar-btn flex items-center gap-1 text-red-500" 
                                        :disabled="recycleFiles.length === 0" 
                                        @click="emptyRecycleBin"
                                    >
                                        <i class="fa fa-trash"></i>
                                        <span>清空回收站</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 工具栏 -->
                            <div class="card p-3 mb-6">
                                <div class="flex flex-wrap gap-2 items-center justify-between">
                                    <div class="flex gap-2">
                                        <button class="toolbar-btn flex items-center gap-1" :disabled="selectedFiles.length === 0" @click="restoreSelected">
                                            <i class="fa fa-undo"></i>
                                            <span>还原</span>
                                        </button>
                                        <button class="toolbar-btn flex items-center gap-1 text-red-500" :disabled="selectedFiles.length === 0" @click="deletePermanentlySelected">
                                            <i class="fa fa-times"></i>
                                            <span>永久删除</span>
                                        </button>
                                    </div>
                                    
                                    <div class="flex gap-3 items-center">
                                        <div class="text-sm text-gray-500 mr-1">排序方式:</div>
                                        <select v-model="sortBy" class="border rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none" @change="sortFiles">
                                            <option value="deleteTime">按删除时间</option>
                                            <option value="name">按名称</option>
                                            <option value="size">按大小</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 空状态 -->
                            <div v-if="recycleFiles.length === 0" class="card p-10 text-center">
                                <i class="fa fa-trash text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-medium mb-2">回收站是空的</h3>
                                <p class="text-gray-500 max-w-md">已删除的文件会显示在这里，您可以还原或永久删除它们</p>
                                <button class="mt-6 toolbar-btn-primary" @click="navigateToFileManager">
                                    <i class="fa fa-folder"></i> 前往文件库
                                </button>
                            </div>
                            
                            <!-- 文件列表 -->
                            <div v-else class="card overflow-hidden">
                                <div class="grid grid-cols-12 px-4 py-3 border-b text-sm font-medium text-gray-500">
                                    <div class="col-span-1"></div>
                                    <div class="col-span-5 md:col-span-4">名称</div>
                                    <div class="hidden md:block col-span-2">原位置</div>
                                    <div class="col-span-3 md:col-span-2">删除时间</div>
                                    <div class="hidden md:block col-span-2">大小</div>
                                    <div class="col-span-3 md:col-span-1 text-right">操作</div>
                                </div>
                                
                                <div v-for="file in recycleFiles" :key="file.id" class="file-list-row">
                                    <div class="col-span-1 w-12">
                                        <input type="checkbox" v-model="selectedFiles" :value="file.id" class="rounded text-primary focus:ring-primary">
                                    </div>
                                    <div class="col-span-5 md:col-span-4 flex items-center gap-3 flex-1">
                                        <i class="fa" :class="file.isFolder ? 'fa-folder text-yellow-500' : getFileIconClass(file.type)"></i>
                                        <span>{{ file.name }}</span>
                                    </div>
                                    <div class="hidden md:block col-span-2 text-sm text-gray-500">
                                        {{ file.originalPath }}
                                    </div>
                                    <div class="col-span-3 md:col-span-2 text-sm text-gray-500">
                                        {{ formatTime(file.deleteTime) }}
                                    </div>
                                    <div class="hidden md:block col-span-2 text-sm text-gray-500">
                                        {{ file.size ? formatSize(file.size) : '-' }}
                                    </div>
                                    <div class="col-span-3 md:col-span-1 flex justify-end gap-2">
                                        <button @click="restoreFile(file.id)" class="text-sm p-1 hover:bg-neutral rounded" title="还原">
                                            <i class="fa fa-undo text-primary"></i>
                                        </button>
                                        <button @click="deletePermanently(file.id)" class="text-sm p-1 hover:bg-neutral rounded" title="永久删除">
                                            <i class="fa fa-times text-red-500"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                    
                    <!-- 底部状态栏 -->
                    <Footer 
                        :selected-count="selectedFiles.length" 
                        :total-files="recycleFiles.length"
                        :deleted-storage="formatSize(totalDeletedSize)"
                    ></Footer>
                </div>
            `,
            data() {
                return {
                    sidebarOpen: true,
                    isMobile: window.innerWidth < 768,
                    recycleFiles: [],
                    selectedFiles: [],
                    sortBy: 'deleteTime',
                    totalDeletedSize: 0
                }
            },
            mounted() {
                // 监听窗口大小变化
                window.addEventListener('resize', this.handleResize);
                this.handleResize();
                
                // 加载回收站文件
                this.loadRecycleFiles();
            },
            beforeUnmount() {
                window.removeEventListener('resize', this.handleResize);
            },
            methods: {
                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                },
                handleResize() {
                    this.isMobile = window.innerWidth < 768;
                    if (window.innerWidth >= 768) {
                        this.sidebarOpen = true;
                    }
                },
                // 加载回收站文件（调用后端 /api/recycle-bin）
                async loadRecycleFiles() {
                    if (!window.CloudApi || typeof CloudApi.apiGet !== 'function') {
                        console.error('CloudApi 未加载，无法请求回收站数据');
                        alert('页面缺少 api.js，暂时无法获取回收站数据，请刷新或检查引用。');
                        return;
                    }
                    try {
                        const res = await CloudApi.apiGet('/recycle-bin');
                        let list = [];
                        if (res && res.success && Array.isArray(res.data)) {
                            list = res.data;
                        } else if (Array.isArray(res)) {
                            list = res;
                        }
                        // map 后端字段到前端显示字段
                        this.recycleFiles = list.map(f => ({
                            id: f.id || f.file_id || f.fileId,
                            name: f.filename || f.name || f.file_name,
                            isFolder: f.isFolder || false,
                            originalPath: f.original_path || f.originalPath || '/',
                            deleteTime: f.delete_time || f.deleteTime || new Date().toISOString(),
                            type: f.file_type || f.type || 'file',
                            size: f.filesize || f.size || 0
                        }));
                        this.calculateTotalSize();
                        this.sortFiles();
                    } catch (e) {
                        console.error('加载回收站失败', e);
                    }
                },
                // 计算总大小
                calculateTotalSize() {
                    this.totalDeletedSize = this.recycleFiles.reduce((total, file) => {
                        return total + (file.size || 0);
                    }, 0);
                },
                // 排序文件
                sortFiles() {
                    this.recycleFiles.sort((a, b) => {
                        if (this.sortBy === 'name') {
                            return a.name.localeCompare(b.name);
                        } else if (this.sortBy === 'deleteTime') {
                            return new Date(b.deleteTime) - new Date(a.deleteTime);
                        } else if (this.sortBy === 'size') {
                            return (b.size || 0) - (a.size || 0);
                        }
                        return 0;
                    });
                },
                // 还原单个文件（调用后端 /api/recycle-bin/restore）
                async restoreFile(fileId) {
                    if (!confirm('确定要还原此文件吗？')) return;
                    try {
                        const res = await CloudApi.apiPost('/recycle-bin/restore', { fileId });
                        if (res && res.success) {
                            this.recycleFiles = this.recycleFiles.filter(file => file.id !== fileId);
                            this.selectedFiles = this.selectedFiles.filter(id => id !== fileId);
                            this.calculateTotalSize();
                            alert('文件已还原到原位置');
                        } else {
                            alert(res.message || '还原失败');
                        }
                    } catch (e) {
                        console.error('还原失败', e);
                        alert('还原失败，请稍后重试');
                    }
                },
                // 还原选中文件（循环调用还原接口）
                async restoreSelected() {
                    if (this.selectedFiles.length === 0) return;
                    if (!confirm(`确定要还原选中的 ${this.selectedFiles.length} 个文件吗？`)) return;
                    try {
                        for (const id of [...this.selectedFiles]) {
                            const res = await CloudApi.apiPost('/recycle-bin/restore', { fileId: id });
                            if (res && res.success) {
                                this.recycleFiles = this.recycleFiles.filter(f => f.id !== id);
                                this.selectedFiles = this.selectedFiles.filter(x => x !== id);
                            } else {
                                console.warn('还原失败：', id, res && res.message);
                            }
                        }
                        this.calculateTotalSize();
                        alert('选中的文件已还原（可能部分失败，请查看控制台）');
                    } catch (e) {
                        console.error('批量还原失败', e);
                        alert('还原过程中发生错误，请稍后重试');
                    }
                },
                // 永久删除单个文件
                // 注意：后端当前没有提供单文件永久删除接口，提供的是清空回收站（全部永久删除）。
                // 因此此处引导用户使用“清空回收站”或与后端协商添加单文件删除接口。
                deletePermanently(fileId) {
                    if (!confirm('后端未提供单文件永久删除接口。要永久删除该文件，请选择“清空回收站”（将删除所有回收站文件）。确定继续？')) return;
                    // 直接调用清空回收站（警告：会删除全部回收站内容）
                    this.emptyRecycleBin();
                },
                // 永久删除选中文件（后端无单文件永久删除接口，改为清空回收站）
                deletePermanentlySelected() {
                    if (this.selectedFiles.length === 0) return;
                    if (!confirm('后端不支持针对选中文件的永久删除。要永久删除，请选择清空回收站（将删除所有回收站文件）。确定继续？')) return;
                    this.emptyRecycleBin();
                },
                // 清空回收站（调用后端 /api/recycle-bin/empty）
                async emptyRecycleBin() {
                    if (!confirm('确定要清空回收站吗？所有文件将被永久删除，此操作不可恢复！')) return;
                    try {
                        const res = await CloudApi.apiPost('/recycle-bin/empty', {});
                        if (res && res.success) {
                            this.recycleFiles = [];
                            this.selectedFiles = [];
                            this.calculateTotalSize();
                            alert('回收站已清空');
                        } else {
                            alert(res.message || '清空回收站失败');
                        }
                    } catch (e) {
                        console.error('清空回收站失败', e);
                        alert('清空回收站出错，请稍后重试');
                    }
                },
                // 导航到文件管理器
                navigateToFileManager() {
                    window.location.href = 'file-manager.html';
                },
                // 获取文件图标类名
                getFileIconClass(type) {
                    switch(type) {
                        case 'image': return 'fa-file-image text-green-500';
                        case 'document': return 'fa-file-alt text-blue-500';
                        case 'pdf': return 'fa-file-pdf text-red-500';
                        case 'video': return 'fa-file-video text-purple-500';
                        case 'audio': return 'fa-file-audio text-orange-500';
                        default: return 'fa-file text-gray-500';
                    }
                },
                // 格式化时间
                formatTime(timeString) {
                    const date = new Date(timeString);
                    return date.toLocaleString();
                },
                // 格式化文件大小
                formatSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
            }
        };

        // 路由配置
        const routes = [
            {
                path: '/',
                name: 'recycle-bin',
                component: RecycleBin
            }
        ];

        // 创建路由实例
        const router = VueRouter.createRouter({
            history: VueRouter.createWebHashHistory(),
            routes
        });

        // 应用路由守卫
        router.beforeEach(authGuard);

        // 创建并挂载应用
        const { createApp } = Vue;
        createApp({})
            .use(router)
            .component('Header', Header)
            .component('Sidebar', Sidebar)
            .component('Footer', Footer)
            .mount('#app');
    </script>
</body>
</html>