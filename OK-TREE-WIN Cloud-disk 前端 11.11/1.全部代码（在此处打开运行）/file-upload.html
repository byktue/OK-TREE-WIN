<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传 - 云盘存储</title>
    <!-- 1. 修复tailwind is not defined：补充Tailwind CSS和配置JS的CDN引入 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script>
        // Tailwind配置（需在Tailwind CDN之后引入，否则报错）
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4299e1',
                        neutral: '#f7fafc',
                        'gray-light': '#718096',
                        'dark': '#2d3748'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-card {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            .shadow-hover {
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            }
            .upload-area {
                @apply border-2 border-dashed border-gray-200 rounded-xl p-10 text-center mb-6 hover:border-primary/50 transition-colors cursor-pointer;
            }
            .progress-container {
                @apply space-y-4 mb-6;
            }
            .progress-item {
                @apply text-sm;
            }
            .action-btn {
                @apply flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200;
            }
            .action-btn-primary {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .action-btn-secondary {
                @apply bg-white border border-gray-200 hover:bg-neutral;
            }
            .error-text {
                @apply text-red-500 text-sm mt-2;
            }
        }
    </style>
</head>
<body class="font-inter bg-neutral min-h-screen flex flex-col text-dark">
    <div id="app">
        <!-- 头部导航 -->
        <header class="bg-white shadow-sm px-4 py-3 flex items-center justify-between z-20">
            <div class="flex items-center gap-4">
                <button @click="goBack" class="text-dark p-2 rounded-full hover:bg-neutral transition-all">
                    <i class="fa fa-arrow-left"></i>
                </button>
                <div class="flex items-center gap-2">
                    <i class="fa fa-cloud text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold text-dark">云盘存储</h1>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="flex-1 p-4 md:p-6 max-w-4xl mx-auto w-full">
            <div class="bg-white rounded-xl shadow-card p-6">
                <h2 class="text-xl font-medium mb-6">上传文件</h2>
                
                <!-- 错误提示区 -->
                <div v-if="errorMsg" class="error-text text-center mb-4">
                    <i class="fa fa-exclamation-circle mr-1"></i>{{ errorMsg }}
                </div>
                
                <!-- 上传区域 -->
                <div class="upload-area" @click="triggerFileInput" @dragover.prevent @drop.prevent="handleDrop">
                    <i class="fa fa-cloud-upload text-5xl text-primary mb-4"></i>
                    <p class="text-gray-500 mb-2">点击或拖拽文件到此处上传</p>
                    <p class="text-xs text-gray-light">支持JPG/PNG/PDF/DOCX/MP4等格式，单个文件≤100MB</p>
                    <!-- 隐藏的文件选择框 -->
                    <input 
                        type="file" 
                        id="fileInput" 
                        class="hidden" 
                        multiple 
                        @change="handleFileSelection"
                        accept=".jpg,.jpeg,.png,.pdf,.docx,.doc,.xlsx,.xls,.mp4,.mp3"
                    >
                </div>

                <!-- 上传进度列表 -->
                <div v-if="uploadingFiles.length > 0" class="progress-container">
                    <h3 class="font-medium mb-2">上传中...</h3>
                    <div v-for="(file, index) in uploadingFiles" :key="index" class="progress-item">
                        <div class="flex justify-between mb-1">
                            <span class="truncate">{{ file.name }}</span>
                            <span>{{ file.progress }}%</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2">
                            <div 
                                class="bg-primary h-2 rounded-full transition-all duration-300"
                                :style="{ width: file.progress + '%' }"
                            ></div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="flex justify-end gap-3">
                    <button class="action-btn action-btn-secondary" @click="goBack">
                        取消
                    </button>
                    <button class="action-btn action-btn-primary" @click="startUpload" :disabled="uploadingFiles.length === 0 || isUploading">
                        <i class="fa fa-upload mr-1"></i>
                        <span>{{ isUploading ? '上传中...' : '开始上传' }}</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- 2. 修复Vue开发版警告：替换为生产版CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="api.js"></script>
    <script>
        // 登录状态验证（与file-manager.html保持一致）
        const token = localStorage.getItem('cloudDiskToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Vue应用实例
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    uploadingFiles: [],
                    isUploading: false,
                    errorMsg: '',
                    // 3. 修复文件类型不支持：定义支持的文件类型白名单
                    supportedTypes: {
                        'image/jpeg': true,
                        'image/png': true,
                        'application/pdf': true,
                        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': true,
                        'application/msword': true,
                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': true,
                        'application/vnd.ms-excel': true,
                        'video/mp4': true,
                        'audio/mpeg': true
                    },
                    // 支持的文件扩展名（备用：应对MIME类型识别异常）
                    supportedExts: ['jpg', 'jpeg', 'png', 'pdf', 'docx', 'doc', 'xlsx', 'xls', 'mp4', 'mp3'],
                    currentPath: this.getPathFromUrl()
                };
            },
            methods: {
                // 返回文件管理页（带当前路径参数，确保回到原目录）
                goBack() {
                    const path = this.currentPath ? 
                        `file-manager.html?path=${encodeURIComponent(this.currentPath)}` : 
                        'file-manager.html';
                    window.location.href = path;
                },

                // 从URL获取当前路径（如从文件管理页跳转时携带）
                getPathFromUrl() {
                    const params = new URLSearchParams(window.location.search);
                    return params.get('path') || '/';
                },

                // 触发文件选择框
                triggerFileInput() {
                    this.errorMsg = ''; // 清空之前的错误提示
                    document.getElementById('fileInput').click();
                },

                // 4. 修复文件类型不支持：添加文件类型校验逻辑
                checkFileSupport(file) {
                    // 方式1：通过MIME类型校验
                    if (this.supportedTypes[file.type]) return true;
                    
                    // 方式2：通过文件扩展名校验（应对MIME类型识别错误）
                    const ext = file.name.split('.').pop().toLowerCase();
                    return this.supportedExts.includes(ext);
                },

                // 处理文件选择
                handleFileSelection(event) {
                    const files = event.target.files;
                    if (!files.length) return;

                    this.errorMsg = '';
                    const validFiles = [];
                    const invalidFiles = [];

                    // 筛选支持的文件
                    Array.from(files).forEach(file => {
                        if (this.checkFileSupport(file)) {
                            // 额外校验文件大小（≤100MB）
                            if (file.size <= 100 * 1024 * 1024) {
                                validFiles.push({
                                    name: file.name,
                                    size: file.size,
                                    progress: 0,
                                    rawFile: file
                                });
                            } else {
                                invalidFiles.push(`${file.name}（超过100MB）`);
                            }
                        } else {
                            invalidFiles.push(file.name);
                        }
                    });

                    // 处理无效文件提示
                    if (invalidFiles.length > 0) {
                        this.errorMsg = `当前不支持以下文件类型/大小：${invalidFiles.join('、')}，支持格式：${this.supportedExts.join('、')}`;
                    }

                    // 添加有效文件到上传队列
                    if (validFiles.length > 0) {
                        this.uploadingFiles = [...this.uploadingFiles, ...validFiles];
                    }

                    // 清空输入框，允许重复选择同一文件
                    event.target.value = '';
                },

                // 处理拖拽文件
                handleDrop(event) {
                    const files = event.dataTransfer.files;
                    if (!files.length) return;

                    this.errorMsg = '';
                    const validFiles = [];
                    const invalidFiles = [];

                    // 同样校验拖拽的文件
                    Array.from(files).forEach(file => {
                        if (this.checkFileSupport(file)) {
                            if (file.size <= 100 * 1024 * 1024) {
                                validFiles.push({
                                    name: file.name,
                                    size: file.size,
                                    progress: 0,
                                    rawFile: file
                                });
                            } else {
                                invalidFiles.push(`${file.name}（超过100MB）`);
                            }
                        } else {
                            invalidFiles.push(file.name);
                        }
                    });

                    if (invalidFiles.length > 0) {
                        this.errorMsg = `当前不支持以下文件类型/大小：${invalidFiles.join('、')}，支持格式：${this.supportedExts.join('、')}`;
                    }
                    if (validFiles.length > 0) {
                        this.uploadingFiles = [...this.uploadingFiles, ...validFiles];
                    }
                },

                // 开始上传（模拟真实接口逻辑）
                startUpload() {
                    if (this.uploadingFiles.length === 0 || this.isUploading) return;

                    this.isUploading = true;

                    // 真实调用后端上传接口（并发上传）
                    const uploads = this.uploadingFiles.map((file, idx) => {
                        // each file expected to have rawFile property (实际选择时设置)
                        const raw = file.rawFile || file.file || null;
                        if (!raw) {
                            return Promise.reject(new Error('缺少原始文件：' + file.name));
                        }
                        return CloudApi.uploadFile('/files/upload', raw, (p) => {
                            this.uploadingFiles[idx].progress = p;
                        }).then(res => ({ res, idx }));
                    });

                    Promise.allSettled(uploads).then(results => {
                        this.isUploading = false;
                        const failed = results.filter(r => r.status === 'rejected');
                        if (failed.length > 0) {
                            this.errorMsg = '部分文件上传失败，请重试';
                            console.error('上传失败项：', failed);
                        } else {
                            // 上传成功，通知父组件并关闭模态框
                            this.uploadingFiles = [];
                            this.$emit('upload-complete');
                            this.$emit('close');
                        }
                    }).catch(e=>{
                        console.error('上传出错', e);
                        this.isUploading = false;
                        this.errorMsg = '上传过程中发生错误';
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>